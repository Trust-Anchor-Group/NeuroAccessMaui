<?xml version="1.0" encoding="utf-8" ?>
<base:BaseContentPage x:Name="ThisPage"
							 x:Class="NeuroAccessMaui.UI.Pages.Contacts.MyContacts.MyContactsPage"
							 x:DataType="viewmodel:ContactListViewModel"
							 xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
							 xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
							 xmlns:l="clr-namespace:NeuroAccessMaui.Services.Localization"
							 xmlns:ui="clr-namespace:NeuroAccessMaui.UI"
							 xmlns:mct="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
							 xmlns:base="clr-namespace:NeuroAccessMaui.UI.Pages"
							 xmlns:controls="clr-namespace:NeuroAccessMaui.UI.Controls"
							 xmlns:converters="clr-namespace:NeuroAccessMaui.UI.Converters"
							 xmlns:viewmodel="clr-namespace:NeuroAccessMaui.UI.Pages.Contacts.MyContacts">

	<VisualElement.Resources>
		<DataTemplate x:Key="ContactTemplate" x:DataType="viewmodel:ContactInfoModel">
			<Border Style="{DynamicResource BorderSet}">
				<Grid ColumnDefinitions="auto, *, auto, auto, auto" RowDefinitions="auto" ColumnSpacing="8">
					<Border HeightRequest="48" WidthRequest="48" StrokeShape="RoundRectangle 24" Background="{Binding ConnectionSecondaryColor}">
						<controls:SvgView Source="person.svg" TintColor="{Binding ConnectionColor}"
										  HorizontalOptions="Center" VerticalOptions="Center"
										  HeightRequest="32"
										  WidthRequest="32"/>
						<Border.GestureRecognizers>
							<TapGestureRecognizer Command="{Binding ToggleSubscriptionCommand}" />
						</Border.GestureRecognizers>
					</Border>

					<Label Grid.Column="1" HorizontalOptions="Start" VerticalTextAlignment="Center" LineBreakMode="TailTruncation"
						   Text="{Binding Path=FriendlyName}" Style="{DynamicResource Brand2LabelS}"/>

					<Frame Grid.Column="2" CornerRadius="12" Padding="8,3,8,3" IsVisible="{Binding HasEvents}"
						   HorizontalOptions="End" VerticalOptions="Center" Style="{DynamicResource AlertFrame}">
						<Label Style="{DynamicResource AlertLabel}" Text="{Binding NrEvents}" Padding="1"/>
					</Frame>

					<controls:SvgButton SvgSource="chat.svg" Style="{DynamicResource IconButtonOnBackground}"
										VerticalOptions="Center"
										Grid.Column="3"
										Command="{Binding ViewChatCommand}"/>

					<controls:SvgButton SvgSource="person.svg" Style="{DynamicResource IconButtonOnBackground}"
										VerticalOptions="Center"
										Grid.Column="4"
										Command="{Binding ViewContactCommand}"/> 

				</Grid>
			</Border>
		</DataTemplate>
	</VisualElement.Resources>

	<Grid BackgroundColor="{DynamicResource SurfaceBackgroundWL}">

		<controls:Background/>

		<ScrollView>
			<VerticalStackLayout Spacing="{DynamicResource SmallSpacing}" Margin="{DynamicResource SmallMargins}">
				<Grid ColumnDefinitions="*, auto" Margin="8,8,8,0">
					<controls:SvgButton
						Grid.Row="0" Grid.Column="0"
						Command="{Binding GoBackCommand}"
						SvgSource="close.svg"
						Style="{DynamicResource IconButton}"
						HorizontalOptions="Start"
						WidthRequest="44"
						HeightRequest="44"/>

					<Label Text="{l:Localize Contacts}" Style="{DynamicResource PageTitleLabel}" Grid.Column="1"/>
				</Grid>

				<Border Style="{DynamicResource BorderSet}">
					<VerticalStackLayout Spacing="{DynamicResource LargeSpacing}">
						<Label Text="{Binding Description}" HorizontalOptions="Center" VerticalOptions="Start"
								 IsVisible="{Binding Description, Converter={converters:OnlyShowNonEmpty}}"/>

						<Label Style="{DynamicResource AlertLabel}" HorizontalOptions="Center" HorizontalTextAlignment="Center"
								 VerticalOptions="Start" IsVisible="{Binding Path=ShowContactsMissing}" Text="{l:Localize NoContactsFound}" />

						<controls:TextButton LabelData="{Binding AnonymousText}" Style="{DynamicResource FilledTextButton}"
													Command="{Binding AnonymousCommand}" IsVisible="{Binding AllowAnonymous}"/>
						<controls:TextButton LabelData="{l:Localize ScanQRCode}" Style="{DynamicResource FilledTextButton}"
													Command="{Binding ScanQrCodeCommand}" IsVisible="{Binding CanScanQrCode}"/>
					</VerticalStackLayout>
				</Border>

				<!-- Use collectionview to maintain logic when page is opened in selection mode, like selecting a contact for add contract part of payments -->
				<controls:ConditionView Condition="{Binding IsViewMode}">
					<controls:ConditionView.True>
						<VerticalStackLayout BindableLayout.ItemsSource="{Binding Contacts}" BindableLayout.ItemTemplate="{StaticResource ContactTemplate}"/>
					</controls:ConditionView.True>
					
					<controls:ConditionView.False>
						<CollectionView x:Name="Contacts" VerticalOptions="Start" ItemSizingStrategy="MeasureAllItems"
										SelectionMode="Single" ItemsSource="{Binding Path=Contacts}"
										SelectedItem="{Binding Path=SelectedContact, Mode=TwoWay}"
										ItemTemplate="{StaticResource ContactTemplate}">
						</CollectionView>
					</controls:ConditionView.False>
				</controls:ConditionView>
				
			</VerticalStackLayout>
		</ScrollView>
	</Grid>
</base:BaseContentPage>
