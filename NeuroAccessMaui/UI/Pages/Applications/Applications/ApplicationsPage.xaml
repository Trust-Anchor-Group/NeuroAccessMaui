<?xml version="1.0" encoding="utf-8" ?>
<base:BaseContentPage x:Name="ThisPage"
							 x:Class="NeuroAccessMaui.UI.Pages.Applications.Applications.ApplicationsPage"
							 x:DataType="viewmodel:ApplicationsViewModel"
							 xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
							 xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
							 xmlns:l="clr-namespace:NeuroAccessMaui.Services.Localization"
							 xmlns:ui="clr-namespace:NeuroAccessMaui.UI"
							 xmlns:mct="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
							 xmlns:base="clr-namespace:NeuroAccessMaui.UI.Pages"
							 xmlns:controls="clr-namespace:NeuroAccessMaui.UI.Controls"
							 xmlns:converters="clr-namespace:NeuroAccessMaui.UI.Converters"
							 xmlns:viewmodel="clr-namespace:NeuroAccessMaui.UI.Pages.Applications.Applications"
							 xmlns:service="clr-namespace:NeuroAccessMaui.Services.Kyc">
							 
<base:BaseContentPage.Resources>
  <ResourceDictionary>
    <Style TargetType="Label" x:Key="CardTitleLabel">
      <Setter Property="FontFamily" Value="SpaceGroteskBold"/>
      <Setter Property="FontSize" Value="16"/>
	  <Setter Property="TextColor" Value="{DynamicResource ContentPrimaryWL}"/>
    </Style>
	<Style TargetType="Label" x:Key="CardSubtitleLabel">
      <Setter Property="FontFamily" Value="SpaceGroteskRegular"/>
      <Setter Property="FontSize" Value="14"/>
	  <Setter Property="TextColor" Value="{DynamicResource ContentSecondaryWL}"/>
    </Style>
  </ResourceDictionary>
</base:BaseContentPage.Resources>

	<Grid BackgroundColor="{DynamicResource SurfaceBackgroundWL}" Margin="16,16,16,0">

		<controls:Background/>

		<ScrollView>
			<VerticalStackLayout Spacing="24" Margin="0" Padding="0">
				<Grid Margin="0">
					<controls:SvgButton
						Command="{Binding GoBackCommand}"
						SvgSource="close.svg"
						Style="{DynamicResource IconButton}"
						HorizontalOptions="Start"/>

					<Label Style="{DynamicResource PageTitleLabel}" Text="{l:Localize Applications}" HorizontalOptions="End"/>
				</Grid>

				<!-- Current Application (0 or 1) -->
				<Label Text="Current application" TextColor="{DynamicResource ContentSecondaryWL}" FontSize="16" FontFamily="SpaceGroteskBold" />
				<controls:TemplatedButton Command="{Binding OpenApplicationCommand}"
										  CommandParameter="{Binding CurrentApplication}"
										  Margin="0"
										  Padding="0">
					<Border Style="{DynamicResource BorderSet}" Margin="0" Padding="16">
						<Grid
							  ColumnDefinitions="auto,*"
							  RowDefinitions="auto,auto,auto,auto" RowSpacing="16">
								<controls:UriImage Source="{Binding BannerUri}"
									   Grid.Row="0" Grid.Column="0"
									   HeightRequest="30"
									   VerticalOptions="Center"  HorizontalOptions="Start"/>
								<controls:SvgButton Style="{DynamicResource IconButton}" 
									   SvgSource="arrow_forward.svg"
									   Grid.Row="0" Grid.Column="1" 
									   HorizontalOptions="End" 
									   InputTransparent="True" Margin="0"/>
								<VerticalStackLayout  Grid.Row="1" Grid.Column="0">
									<Label Text="Personal ID" Style="{DynamicResource CardTitleLabel}"/> 
									<Label Text="Identity Verification" Style="{DynamicResource CardSubtitleLabel}"/>
								</VerticalStackLayout>
								<VerticalStackLayout Grid.Row="2" Grid.ColumnSpan="2" Spacing="4">
									<Grid ColumnDefinitions="*,Auto">
										<Label Grid.Column="0" Text="{l:Localize Progress}"/>
										<Label Grid.Column="1" Text="{Binding CurrentApplication.Progress, StringFormat='{}{0:P0}'}" />
									</Grid>
									<controls:ProgressBar Progress="{Binding CurrentApplication.Progress}" 					
										HeightRequest="16"
									  	CornerRadius="32"
									  	TrackBrush="{DynamicResource TnPAccent2bgWL}"
									  	BarBrush="{DynamicResource TnPAccent2FigureWL}"
									  	Margin="{DynamicResource SmallBottomMargins}"/>

									<Grid Grid.Row="3" Grid.ColumnSpan="2" ColumnDefinitions="*,Auto" >
										<Label Grid.Column="0" Text="{l:Localize LastUpdatedFormat}" />
										<Border Grid.Column="1" Padding="8,2,8,2" Background="{DynamicResource TnPWarningbgWL}" StrokeShape="RoundRectangle 8">
											<Label 
												Text="Pending..."
												FontSize="16" FontFamily="SpaceGroteskBold"/>
										</Border>
									</Grid>
								</VerticalStackLayout>

						</Grid>
					</Border>
				</controls:TemplatedButton>
				
				<Label Text="Available applications"
					   TextColor="{DynamicResource ContentSecondaryWL}"
					   FontSize="16"
					   FontFamily="SpaceGroteskBold" />

				<Border Style="{DynamicResource BorderSet}">
						<VerticalStackLayout Spacing="{DynamicResource SmallSpacing}">
							<Label Style="{DynamicResource SectionTitleLabel}" Text="{l:Localize IdentityApplications}" />

							<controls:TemplatedButton IsVisible="{Binding HasCurrentApplication}"
													  Command="{Binding OpenApplicationCommand}"
													  CommandParameter="{Binding CurrentApplication}">
								<Border Style="{DynamicResource SecondaryButtonActiveBorder}">
									<Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
										<Label Grid.Row="0" Grid.Column="0" Style="{DynamicResource KeyLabel}"
											   Text="{Binding CurrentApplication.FriendlyName}" InputTransparent="True" />
										<Label Grid.Row="1" Grid.Column="0" Style="{DynamicResource ValueLabel}"
											   Text="{Binding CurrentApplication.UpdatedUtc, StringFormat='{}{0:g}'}" InputTransparent="True" />

										<Border Grid.Row="1" Grid.Column="1" Padding="8,2"
											   StrokeShape="RoundRectangle 12 12 12 12"
											   BackgroundColor="{Binding CurrentApplication.CreatedIdentityState, Converter={converters:IdentityStateToColor}}"
											   VerticalOptions="Center" InputTransparent="True">
											<Border.Triggers>
												<DataTrigger TargetType="Border" Binding="{Binding CurrentApplication.CreatedIdentityId}" Value="">
													<Setter Property="BackgroundColor" Value="{DynamicResource TnPWarningContentWL}" />
												</DataTrigger>
											</Border.Triggers>

										<Label Text="{Binding CurrentApplication.CreatedIdentityState,
													  Converter={converters:LocalizedState},
													  StringFormat='{}{0}'}" >
										<Label.Triggers>
												<DataTrigger TargetType="Label" Binding="{Binding CurrentApplication.CreatedIdentityId}" Value="">
													<Setter Property="Text" Value="In Progress" />
												</DataTrigger>
											</Label.Triggers>
										</Label>
									</Border>
								</Grid>
							</Border>
						</controls:TemplatedButton>

						<Label IsVisible="{Binding HasCurrentApplication, Converter={StaticResource InvertedBoolConverter}}"
							   Style="{DynamicResource ValueLabel}"
							   Text="No current identity application." />
						</VerticalStackLayout>
					</Border>

					<!-- Start new process -->
					<Border Style="{DynamicResource BorderSet}">
						<VerticalStackLayout Spacing="{DynamicResource SmallSpacing}">
							<Label Style="{DynamicResource SectionTitleLabel}" Text="Start new process" />
							<controls:TemplatedButton HorizontalOptions="Fill" Command="{x:Binding CreateNewApplicationCommand}">
								<Border Style="{DynamicResource PrimaryButtonActiveBorder}" InputTransparent="True">
									<VerticalStackLayout Spacing="{DynamicResource SmallSpacing}" InputTransparent="True">
										<Label Style="{DynamicResource SectionTitleLabel}" Text="New Application" InputTransparent="True"
											   TextColor="{DynamicResource ButtonAccessPrimaryContentWL}"/>
										<Label Style="{DynamicResource KeyLabel}" Text="Start a new KYC application process. If you have one in review, it will be obsoleted." InputTransparent="True"
											   TextColor="{DynamicResource ButtonAccessPrimaryContentWL}"/>
									</VerticalStackLayout>
								</Border>
							</controls:TemplatedButton>
						</VerticalStackLayout>
					</Border>

				<!-- Removed old grouped sections in favor of unified list above -->
			</VerticalStackLayout>
		</ScrollView>
	</Grid>
</base:BaseContentPage>
