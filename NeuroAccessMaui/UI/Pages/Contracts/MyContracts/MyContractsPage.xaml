<?xml version="1.0" encoding="utf-8" ?>
<base:BaseContentPage x:Name="ThisPage"
					 x:Class="NeuroAccessMaui.UI.Pages.Contracts.MyContracts.MyContractsPage"
					 x:DataType="viewmodel:MyContractsViewModel"
					 xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
					 xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
					 xmlns:l="clr-namespace:NeuroAccessMaui.Services.Localization"
					 xmlns:ui="clr-namespace:NeuroAccessMaui.UI"
					 xmlns:mct="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
					 xmlns:base="clr-namespace:NeuroAccessMaui.UI.Pages"
					 xmlns:controls="clr-namespace:NeuroAccessMaui.UI.Controls"
					 xmlns:converters="clr-namespace:NeuroAccessMaui.UI.Converters"
					 xmlns:viewmodel="clr-namespace:NeuroAccessMaui.UI.Pages.Contracts.MyContracts"
					 xmlns:objectmodel="clr-namespace:NeuroAccessMaui.UI.Pages.Contracts.MyContracts.ObjectModels">
	
	<VisualElement.Resources>
		<DataTemplate x:Key="ContractModelTemplate" x:DataType="objectmodel:ContractModel">
			<Border Style="{DynamicResource BorderSet}">
				<controls:TemplatedButton Padding="0"
								 Command="{Binding ContractSelectedCommand, Source={RelativeSource AncestorType={x:Type viewmodel:MyContractsViewModel}}, x:DataType=viewmodel:MyContractsViewModel}"
								 CommandParameter="{Binding .}">
					<Grid ColumnDefinitions="auto,*,auto" RowDefinitions="auto,auto">
						<Label Grid.Column="0" Grid.Row="0" LineBreakMode="NoWrap" Padding="5,0,5,0"
								Text="{Binding Path=Timestamp, Converter={converters:DateToString}}"
								HorizontalOptions="Center" VerticalOptions="Center"/>
						<Label Grid.Column="0" Grid.Row="1" LineBreakMode="NoWrap" Padding="5,0,5,0"
								Text="{Binding Path=Timestamp, Converter={converters:TimeToString}}"
								HorizontalOptions="Center" VerticalOptions="Center"/>
						<Label Grid.Column="1" Grid.Row="0" Grid.RowSpan="2" LineBreakMode="CharacterWrap" TextType="Text"
								HorizontalTextAlignment="Start" VerticalTextAlignment="Center" Padding="5,0,5,0" Margin="0"
								Text="{Binding Path=NameOrCategory}" Style="{DynamicResource ClickableValueLabel}" VerticalOptions="Center"/>
						<Border Grid.Row="0" Grid.Column="1" Grid.RowSpan="2" StrokeShape="RoundRectangle 12" Margin="0" Padding="8,3,8,3"
								IsVisible="{Binding HasEvents}" HorizontalOptions="End" VerticalOptions="Center"
								Style="{DynamicResource RedButtonActiveBorder}">
							<Label FontSize="Caption" TextColor="{DynamicResource ContentWhitefixed}"
									Text="{Binding NrEvents}" Padding="1"/>
						</Border>
						<!-- Share Template QR button -->
						<controls:SvgButton Grid.Column="2" Grid.Row="0" Grid.RowSpan="2"
											SvgSource="share.svg"
											Style="{DynamicResource IconButtonOnBackground}"
											HorizontalOptions="End"
											VerticalOptions="Center"
											Command="{Binding ShareTemplateQRCommand, Source={RelativeSource AncestorType={x:Type viewmodel:MyContractsViewModel}}, x:DataType=viewmodel:MyContractsViewModel}"
											CommandParameter="{Binding .}"
											IsVisible="{Binding CanShareTemplate, Source={RelativeSource AncestorType={x:Type viewmodel:MyContractsViewModel}}, x:DataType=viewmodel:MyContractsViewModel}" />
					</Grid>
				</controls:TemplatedButton>
			</Border>
		</DataTemplate>
	</VisualElement.Resources>
	
	<Grid BackgroundColor="{DynamicResource SurfaceBackgroundWL}" RowDefinitions="auto, auto, *">

		<controls:Background Grid.RowSpan="3"/>

		<Grid ColumnDefinitions="auto, *, auto" Margin="16,0,16,0">
			<controls:SvgButton
				Command="{Binding GoBackCommand}"
				SvgSource="close.svg"
				Style="{DynamicResource IconButton}"
				HorizontalOptions="Start"/>

			<Label Text="{Binding Path=Title}"
				   Style="{DynamicResource PageTitleLabel}"
				   Margin="{DynamicResource SmallLeftMargins}"
				   Grid.Column="2" HorizontalOptions="End"/>
		</Grid>

		<Border Style="{DynamicResource BorderSet}" Grid.Row="1" Padding="16,16,16,0" Margin="16,16,16,0">
			<VerticalStackLayout>
				<Label Style="{DynamicResource AlertLabel}" HorizontalOptions="Center" HorizontalTextAlignment="Center"
					   VerticalOptions="Center" IsVisible="{Binding Path=ShowContractsMissing}" Text="{l:Localize NoContractsFound}" Margin="0,40,0,0"/>

				<controls:CompositeEntry
					Style="{DynamicResource RegularCompositeEntry}"
					IsVisible="{Binding Path=ShowContractsMissing, Converter={mct:InvertedBoolConverter}}"
					Placeholder="{l:Localize Search}"
					TextChanged="ContractsSearchChanged"
					Margin="0,0,0,16"/>

				<ScrollView Orientation="Horizontal" IsVisible="{Binding Path=IsBusy, Converter={mct:InvertedBoolConverter}}">
					<HorizontalStackLayout BindableLayout.ItemsSource="{Binding FilterTags}" IsVisible="{Binding Path=ShowContractsMissing, Converter={mct:InvertedBoolConverter}}">
						<BindableLayout.ItemTemplate>
							<DataTemplate x:DataType="viewmodel:MyContractsViewModel+SelectableTag">
								<controls:TemplatedButton Padding="4,0,4,16"
														  Command="{Binding FilterChangedCommand, Source={RelativeSource AncestorType={x:Type viewmodel:MyContractsViewModel}}, x:DataType=viewmodel:MyContractsViewModel}"
														  CommandParameter="{Binding .}">
									<Border StrokeShape="RoundRectangle 24" Padding="8"
											Background="{DynamicResource TnPSuccessbgWL}">
										<HorizontalStackLayout>
											<Label Text="{Binding Category}" Style="{DynamicResource Brand2LabelS}" TextColor="{DynamicResource TnPSuccessContentWL}" FontSize="14"/>
											<Label Text=": " Style="{DynamicResource Brand2LabelS}" TextColor="{DynamicResource TnPSuccessContentWL}" FontSize="14"/>
											<Label Text="{Binding Count}" Style="{DynamicResource Brand2LabelS}" TextColor="{DynamicResource TnPSuccessContentWL}" FontSize="14"/>
										</HorizontalStackLayout>

										<Border.Triggers>
											<DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
												<Setter Property="Stroke" Value="{DynamicResource TnPSuccessContentWL}"/>
											</DataTrigger>
											<DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="False">
												<Setter Property="Stroke" Value="Transparent"/>
											</DataTrigger>
										</Border.Triggers>
									</Border>
								</controls:TemplatedButton>
							</DataTemplate>
						</BindableLayout.ItemTemplate>
					</HorizontalStackLayout>
				</ScrollView>
			</VerticalStackLayout>
		</Border>

		<ActivityIndicator x:Name="Loading" IsVisible="{Binding Path=IsBusy}" IsRunning="{Binding Path=IsBusy}"
						   Color="{DynamicResource TnPInfoContentWL}"
						   HorizontalOptions="Center"
						   VerticalOptions="Center"
						   Margin="0,32,0,32"
						   Grid.Row="2"/>

		<CollectionView x:Name="Contracts" VerticalOptions="Start"
						Grid.Row="2" IsVisible="{Binding Path=IsBusy, Converter={mct:InvertedBoolConverter}}"
						Margin="8"
						SelectionMode="None"
						ItemSizingStrategy="MeasureFirstItem"
						ItemsSource="{Binding Path=Contracts}"
						ItemTemplate="{StaticResource ContractModelTemplate}"
						RemainingItemsThreshold="{Binding HasMore}"
						RemainingItemsThresholdReachedCommand="{Binding LoadMoreContractsCommand}">
			<CollectionView.ItemsLayout>
				<GridItemsLayout Orientation="Vertical"/>
			</CollectionView.ItemsLayout>
		</CollectionView>

	</Grid>
</base:BaseContentPage>
