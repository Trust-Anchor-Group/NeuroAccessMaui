<?xml version="1.0" encoding="utf-8" ?>
<base:BaseContentPage x:Name="ThisPage"
					 x:Class="NeuroAccessMaui.UI.Pages.Contracts.MyContracts.MyContractsPage"
					 x:DataType="viewmodel:MyContractsViewModel"
					 xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
					 xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
					 xmlns:l="clr-namespace:NeuroAccessMaui.Services.Localization"
					 xmlns:ui="clr-namespace:NeuroAccessMaui.UI"
					 xmlns:mct="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
					 xmlns:base="clr-namespace:NeuroAccessMaui.UI.Pages"
					 xmlns:controls="clr-namespace:NeuroAccessMaui.UI.Controls"
					 xmlns:converters="clr-namespace:NeuroAccessMaui.UI.Converters"
					 xmlns:viewmodel="clr-namespace:NeuroAccessMaui.UI.Pages.Contracts.MyContracts"
					 xmlns:objectmodel="clr-namespace:NeuroAccessMaui.UI.Pages.Contracts.MyContracts.ObjectModels">
	
	<VisualElement.Resources>
		<DataTemplate x:Key="ContractModelTemplate" x:DataType="objectmodel:ContractModel">
			<Border Style="{DynamicResource BorderSet}">
				<controls:TemplatedButton Padding="0"
								 Command="{Binding ContractSelectedCommand, Source={RelativeSource AncestorType={x:Type viewmodel:MyContractsViewModel}}, x:DataType=viewmodel:MyContractsViewModel}"
								 CommandParameter="{Binding .}">
					<Grid ColumnDefinitions="auto,*,auto" RowDefinitions="auto,auto">
						<Label Grid.Column="0" Grid.Row="0" LineBreakMode="NoWrap" Padding="5,2,5,0"
								Text="{Binding Path=Timestamp, Converter={converters:DateToString}}"
								HorizontalOptions="Center" VerticalOptions="Center"/>
						<Label Grid.Column="0" Grid.Row="1" LineBreakMode="NoWrap" Padding="5,0,5,2"
								Text="{Binding Path=Timestamp, Converter={converters:TimeToString}}"
								HorizontalOptions="Center" VerticalOptions="Center"/>
						<Label Grid.Column="1" Grid.Row="0" Grid.RowSpan="2" LineBreakMode="CharacterWrap" TextType="Text"
								HorizontalTextAlignment="Start" VerticalTextAlignment="Center" Padding="5,2,5,2" Margin="5"
								Text="{Binding Path=NameOrCategory}" Style="{DynamicResource ClickableValueLabel}"/>
						<Border Grid.Row="0" Grid.Column="1" Grid.RowSpan="2" StrokeShape="RoundRectangle 12" Margin="2" Padding="8,3,8,3"
								IsVisible="{Binding HasEvents}" HorizontalOptions="End" VerticalOptions="Center"
								Style="{DynamicResource RedButtonActiveBorder}">
							<Label FontSize="Caption" TextColor="{DynamicResource ContentWhitefixed}"
									Text="{Binding NrEvents}" Padding="1"/>
						</Border>
						<!-- Share Template QR button -->
						<controls:SvgButton Grid.Column="2" Grid.Row="0" Grid.RowSpan="2"
											SvgSource="share.svg"
											Style="{DynamicResource IconButtonOnBackground}"
											HorizontalOptions="End"
											VerticalOptions="Center"
											Command="{Binding ShareTemplateQRCommand, Source={RelativeSource AncestorType={x:Type viewmodel:MyContractsViewModel}}, x:DataType=viewmodel:MyContractsViewModel}"
											CommandParameter="{Binding .}"
											IsVisible="{Binding CanShareTemplate, Source={RelativeSource AncestorType={x:Type viewmodel:MyContractsViewModel}}, x:DataType=viewmodel:MyContractsViewModel}" />
					</Grid>
				</controls:TemplatedButton>
			</Border>
		</DataTemplate>
	</VisualElement.Resources>
	<Grid BackgroundColor="{DynamicResource SurfaceBackgroundWL}" RowDefinitions="auto, *">

		<controls:Background Grid.RowSpan="2"/>

		<Grid ColumnDefinitions="auto, *, auto" Margin="16,0,16,0">
			<controls:SvgButton
				Command="{Binding GoBackCommand}"
				SvgSource="close.svg"
				Style="{DynamicResource IconButton}"
				HorizontalOptions="Start"/>

			<Label Text="{Binding Path=Title}"
				   Style="{DynamicResource PageTitleLabel}"
				   Margin="{DynamicResource SmallLeftMargins}"
				   Grid.Column="2" HorizontalOptions="End"/>
		</Grid>

		<ActivityIndicator x:Name="Loading" IsVisible="{Binding Path=IsBusy}" IsRunning="{Binding Path=IsBusy}"
						   Color="{DynamicResource TnPInfoContentWL}"
						   HorizontalOptions="Center"
						   VerticalOptions="Center"
						   Margin="0,32,0,32"
						   Grid.Row="1"/>

		<ScrollView Grid.Row="1" IsVisible="{Binding Path=IsBusy, Converter={mct:InvertedBoolConverter}}">
			<VerticalStackLayout Margin="8,8,8,16">

				<Border Style="{DynamicResource BorderSet}">
					<VerticalStackLayout Spacing="{DynamicResource LargeSpacing}">
						<Label Style="{DynamicResource AlertLabel}" HorizontalOptions="Center" HorizontalTextAlignment="Center"
								 VerticalOptions="Start" IsVisible="{Binding Path=ShowContractsMissing}" Text="{l:Localize NoContractsFound}" />

						<controls:CompositeEntry
							Style="{DynamicResource RegularCompositeEntry}"
							Placeholder="{l:Localize Search}"
						    TextChanged="ContractsSearchChanged"/>
					</VerticalStackLayout>
				</Border>

				<CollectionView x:Name="Contracts" VerticalOptions="Start"
								ItemSizingStrategy="MeasureAllItems"
								ItemsSource="{Binding Path=Contracts}"
								ItemTemplate="{StaticResource ContractModelTemplate}">
					<CollectionView.ItemsLayout>
						<GridItemsLayout Orientation="Vertical"/>
					</CollectionView.ItemsLayout>
				</CollectionView>
				
			</VerticalStackLayout>
		</ScrollView>
	</Grid>
</base:BaseContentPage>
