<?xml version="1.0" encoding="utf-8" ?>
<base:BaseContentPage x:Name="ThisPage"
							 x:Class="NeuroAccessMaui.UI.Pages.Contracts.NewContract.NewContractPage"
							 x:DataType="viewmodel:NewContractViewModel"
							 xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
							 xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
							 xmlns:l="clr-namespace:NeuroAccessMaui.Services.Localization"
							 xmlns:local="clr-namespace:NeuroAccessMaui.UI.Pages.Contracts.NewContract.ObjectModel"
							 xmlns:ui="clr-namespace:NeuroAccessMaui.UI"
							 xmlns:mct="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
							 xmlns:base="clr-namespace:NeuroAccessMaui.UI.Pages"
							 xmlns:controls="clr-namespace:NeuroAccessMaui.UI.Controls"
							 xmlns:converters="clr-namespace:NeuroAccessMaui.UI.Converters"
							 xmlns:viewmodel="clr-namespace:NeuroAccessMaui.UI.Pages.Contracts.NewContract"
							 xmlns:views="clr-namespace:NeuroAccessMaui.UI.Pages.Contracts.NewContract.Views"
							 xmlns:objectModel="clr-namespace:NeuroAccessMaui.UI.Pages.Contracts.ObjectModel"
							 HideSoftInputOnTapped="True">

	<ContentPage.Resources>
		<objectModel:ParameterTemplateSelector x:Key="ParameterTemplateSelector"
		                                 BooleanTemplate="{StaticResource BooleanParameterTemplate}"
		                                 DateTemplate="{StaticResource DateParameterTemplate}"
		                                 NumericalTemplate="{StaticResource NumericalParameterTemplate}"
		                                 StringTemplate="{StaticResource StringParameterTemplate}"
		                                 TimeTemplate="{StaticResource TimeParameterTemplate}"
		                                 DurationTemplate="{StaticResource DurationParameterTemplate}"
										 ContractReferenceTemplate="{StaticResource ContractReferenceParameterTemplate}"
		                                 DefaultTemplate="{StaticResource DefaultParameterTemplate}" />
	</ContentPage.Resources>

	<Grid x:Name="TheMainGrid"
	  RowDefinitions="auto,*,auto"
	  ColumnDefinitions="*"
	  BackgroundColor="{DynamicResource SurfaceBackgroundWL}">

		<controls:Background Grid.Row ="1"/>

		<!-- Top Bar Simplified -->
		<Grid Grid.Row="0" RowDefinitions="*" ColumnDefinitions="auto,*" Margin="{DynamicResource MediumMargins}">
			<controls:ImageButton Grid.Row="0" Grid.Column="0" IsVisible="{Binding CanStateChange}" Command="{Binding BackCommand}" Style="{DynamicResource ImageOnlyButton}" PathData="{x:Static ui:Geometries.BackButtonPath}" />
			<Label Grid.Row="0" Grid.Column="1" Style="{DynamicResource PageTitleLabel}" Text="{l:Localize NewContract}" HorizontalTextAlignment="End" />
		</Grid>
		<!-- Main Content -->
		<Grid x:Name="StateGrid"
			Grid.Row="1"
			mct:StateContainer.CurrentState="{Binding CurrentState, Mode=OneWayToSource}" 
			mct:StateContainer.CanStateChange="{Binding CanStateChange, Mode=OneWayToSource}" >

			<mct:StateContainer.StateViews>
				<views:LoadingView x:Name="LoadingView" mct:StateView.StateKey="Loading" />
				<views:ParametersView x:Name="ParametersView" mct:StateView.StateKey="Parameters" />
				<views:RolesView x:Name="RolesView" mct:StateView.StateKey="Roles" />
				<views:PreviewView x:Name="PreviewView" mct:StateView.StateKey="Preview" />
				<!-- Inline Final state content to avoid type resolution issues -->
				<Border mct:StateView.StateKey="Final" Style="{DynamicResource BorderSet}">
					<VerticalStackLayout Spacing="12" Padding="{DynamicResource MediumLeftRightBottomMargins}">
						<Label Text="{l:Localize Done}" Style="{DynamicResource PageTitleLabel}" HorizontalTextAlignment="Center" />
						<Label Text="{l:Localize YouCanUploadAttachmentsAndInviteSignersFromTheContractScreen}" Style="{DynamicResource ItemDescriptionLabel}" />
						<controls:TemplatedButton Command="{Binding OpenCreatedContractCommand}">
							<Border Style="{DynamicResource FilledTemplateButtonBorder}" InputTransparent="True" HorizontalOptions="Fill">
								<Grid ColumnDefinitions="Auto,*" HorizontalOptions="Center" VerticalOptions="Center">
									<Label Grid.Column="1" Style="{DynamicResource FilledTemplateButtonLabel}" Margin="{DynamicResource SmallLeftMargins}" Text="{l:Localize ViewContract}" />
								</Grid>
							</Border>
						</controls:TemplatedButton>
					</VerticalStackLayout>
				</Border>
			</mct:StateContainer.StateViews>

			<!-- default state, should not occur -->
			<VerticalStackLayout>
				<Label VerticalTextAlignment="Center" HorizontalTextAlignment="Center" Text="{l:Localize SomethingWentWrong}" />

			</VerticalStackLayout>
		</Grid>

		<!-- Unified Wizard Bottom Bar in own row -->
		<Border Grid.Row="2" Style="{DynamicResource BottomBarBorder2}" Margin="0" Padding="0" IsVisible="{Binding IsOnFinalState, Converter={StaticResource InvertedBoolConverter}}">
			<Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto" Padding="{DynamicResource MediumMargins}" ColumnSpacing="{DynamicResource MediumSpacing}">
				<!-- Row 0: Navigation + Progress + Action -->
				<controls:TemplatedButton Grid.Row="0" Grid.Column="0" Command="{Binding GoPreviousStepCommand}" IsEnabled="{Binding CanGoBack}">
					<Border Style="{DynamicResource TransparentTemplateButtonBorder}" InputTransparent="True" HorizontalOptions="Fill">
						<Grid ColumnDefinitions="Auto,*" HorizontalOptions="Center" VerticalOptions="Center">
							<Label Grid.Column="1" Style="{DynamicResource TransparentTemplateButtonLabel}" Margin="{DynamicResource SmallLeftMargins}"  Text="{l:Localize Back}"/>
						</Grid>
					</Border>
				</controls:TemplatedButton>
				<HorizontalStackLayout Grid.Row="0" Grid.Column="1" HorizontalOptions="Center" VerticalOptions="Center" Spacing="8">
					<Label Text="{Binding ProgressText}" Style="{DynamicResource BottomBarLabel}" />
					<ActivityIndicator IsVisible="{Binding IsValidatingParameters}" IsRunning="{Binding IsValidatingParameters}" Color="{DynamicResource ContentPrimaryWL}" />
				</HorizontalStackLayout>
				<controls:TemplatedButton Grid.Row="0" Grid.Column="2" Command="{Binding GoNextStepCommand}" IsEnabled="{Binding IsCurrentStepValid}">
					<Border Style="{DynamicResource FilledTemplateButtonBorder}"  InputTransparent="True" HorizontalOptions="Fill">
						<Grid ColumnDefinitions="Auto,*" HorizontalOptions="Center" VerticalOptions="Center">
							<Label Grid.Column="1" Style="{DynamicResource FilledTemplateButtonLabel}" Margin="{DynamicResource SmallLeftMargins}" Text="{Binding PrimaryActionText}" />
						</Grid>
					</Border>
				</controls:TemplatedButton>

				<!-- Row 1: Preview Acknowledgment (only visible on preview step) -->
				<Grid Grid.Row="1" Grid.ColumnSpan="3" ColumnDefinitions="Auto,*" IsVisible="{Binding IsOnPreviewStep}" ColumnSpacing="{DynamicResource SmallSpacing}" Padding="{DynamicResource SmallTopMargins}">
					<CheckBox Grid.Column="0" IsChecked="{Binding IsContractOk}" Color="{DynamicResource ContentPrimaryWL}" />
					<Label Grid.Column="1" Text="{l:Localize IHaveReadAndUnderstoodTheContract}" Style="{DynamicResource BottomBarLabel}" />
				</Grid>
			</Grid>
		</Border>





		<!-- 
		<Border Grid.Row="1" Style="{DynamicResource BottomBarBorder}">
			<Grid HorizontalOptions="Fill" VerticalOptions="Center">
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="*" />
					<ColumnDefinition Width="*" />
				</Grid.ColumnDefinitions>

				<controls:TemplatedButton Grid.Column="0" Command="{x:Binding BackCommand}">
					<Border Style="{DynamicResource TransparentTemplateButtonBorder}" InputTransparent="True" HorizontalOptions="Fill">
						<Grid ColumnDefinitions="Auto,*" HorizontalOptions="Center" VerticalOptions="Center">
							<Path VerticalOptions="Center" HeightRequest="24" WidthRequest="24" Aspect="Uniform"
							  Data="{x:Static ui:Geometries.ScanQrIconPath}"
							  Style="{DynamicResource TransparentTemplateButtonPath}"
							  />
							<Label Grid.Column="1" Style="{DynamicResource TransparentTemplateButtonLabel}" Margin="{DynamicResource SmallLeftMargins}"  Text="{l:Localize ScanQRShort}"/>
						</Grid>
					</Border>
				</controls:TemplatedButton>

				<controls:TemplatedButton Grid.Column="1" Command="{x:Binding TestCommand}">
					<Border Style="{DynamicResource FilledTemplateButtonBorder}"  InputTransparent="True" HorizontalOptions="Fill">
						<Grid ColumnDefinitions="Auto,*" HorizontalOptions="Center" VerticalOptions="Center">
							<Path VerticalOptions="Center" HeightRequest="24" WidthRequest="24" Aspect="Uniform"
							  Data="{x:Static ui:Geometries.ShowIdIconPath}"
							  Style="{DynamicResource FilledTemplateButtonPath}"
						/>
							<Label Grid.Column="1" Style="{DynamicResource FilledTemplateButtonLabel}" Margin="{DynamicResource SmallLeftMargins}" Text="{l:Localize ShowIDShort}" />
						</Grid>
					</Border>
				</controls:TemplatedButton>
			</Grid>
		</Border>

	
<Grid BackgroundColor="{DynamicResource SurfaceBackgroundWL}">
    <controls:Background/>

    <ScrollView>
        <VerticalStackLayout>
            <CollectionView ItemsSource="{Binding Parameters}"
                            ItemTemplate="{StaticResource ParameterTemplateSelector}"
                            VerticalOptions="Fill"
                            HorizontalOptions="Fill" />
            <ContentView Content="{Binding Path=HumanReadableText}" Margin="{DynamicResource SmallTopMargins}" />
        </VerticalStackLayout>
    </ScrollView>
</Grid>
-->
	</Grid>

</base:BaseContentPage>
