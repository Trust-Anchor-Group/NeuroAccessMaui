<?xml version="1.0" encoding="utf-8" ?>
<base:BaseContentPage x:Class="NeuroAccessMaui.UI.Pages.Main.Nfc.NfcPage"
					  x:DataType="viewmodel:NfcViewModel"
					  xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
					  xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
					  xmlns:l="clr-namespace:NeuroAccessMaui.Services.Localization"
					  xmlns:base="clr-namespace:NeuroAccessMaui.UI.Pages"
					  xmlns:controls="clr-namespace:NeuroAccessMaui.UI.Controls"
					  xmlns:nfc="clr-namespace:NeuroAccessMaui.Services.Nfc.Ui"
					  xmlns:viewmodel="clr-namespace:NeuroAccessMaui.UI.Pages.Main.Nfc">
	<base:BaseContentPage.Resources>
		<ResourceDictionary>
			<!-- Field Styles (copied from existing key/value UI patterns) -->
			<Style x:Key="FieldKeyLabel"
				   TargetType="Label">
				<Setter Property="FontSize"
						Value="14"/>
				<Setter Property="FontFamily"
						Value="SpaceGroteskRegular"/>
				<Setter Property="TextColor"
						Value="{DynamicResource ContentSecondaryWL}"/>
			</Style>
			<Style x:Key="FieldValueLabel"
				   TargetType="Label">
				<Setter Property="FontSize"
						Value="16"/>
				<Setter Property="FontFamily"
						Value="SpaceGroteskRegular"/>
				<Setter Property="TextColor"
						Value="{DynamicResource ContentSecondaryWL}"/>
			</Style>
			<Style x:Key="FieldTitleLabel"
				   TargetType="Label">
				<Setter Property="FontSize"
						Value="14"/>
				<Setter Property="FontFamily"
						Value="SpaceGroteskBold"/>
				<Setter Property="TextColor"
						Value="{DynamicResource ContentSecondaryWL}"/>
			</Style>
		</ResourceDictionary>
	</base:BaseContentPage.Resources>

	<Grid RowDefinitions="auto,auto,*"
		  BackgroundColor="{DynamicResource SurfaceBackgroundWL}"
		  Padding="{DynamicResource LargeMargins}">
		<Grid ColumnDefinitions="auto,*"
			  ColumnSpacing="16">
			<controls:SvgButton Grid.Row="0"
								Grid.Column="0"
								Command="{Binding GoBackCommand}"
								SvgSource="close.svg"
								Style="{DynamicResource IconButton}"
								HorizontalOptions="Start"
								WidthRequest="44"
								HeightRequest="44"/>
			<Label Grid.Column="1"
				   Text="{l:Localize NFC}"
				   Style="{DynamicResource PageTitleLabel}"
				   VerticalOptions="Center"/>
		</Grid>

		<Grid Grid.Row="1"
			  ColumnDefinitions="*,*,*"
			  ColumnSpacing="12"
			  Margin="0,16,0,0">
			<controls:TextButton Grid.Column="0"
								 Command="{Binding SelectReadTabCommand}"
								 Style="{Binding ReadTabButtonStyle}"
								 LabelData="{l:Localize NfcRead}"/>
			<controls:TextButton Grid.Column="1"
								 Command="{Binding SelectWriteTabCommand}"
								 Style="{Binding WriteTabButtonStyle}"
								 LabelData="{l:Localize NfcWrite}"/>
			<controls:TextButton Grid.Column="2"
								 Command="{Binding SelectHistoryTabCommand}"
								 Style="{Binding HistoryTabButtonStyle}"
								 LabelData="{l:Localize NfcHistory}"/>
		</Grid>

		<controls:ViewSwitcher Grid.Row="2"
							   Margin="0,16,0,0"
							   SelectedStateKey="{Binding SelectedTabKey, Mode=TwoWay}">
			<controls:ViewSwitcher.StateViews>
				<controls:ViewSwitcherStateView StateKey="Read">
					<ScrollView>
						<VerticalStackLayout Spacing="12">
							<Label Text="{l:Localize NfcTapTag}"
								   Style="{DynamicResource InfoLabel}"/>

							<Border Style="{DynamicResource BorderSet}"
									Margin="0">
								<Grid ColumnDefinitions="*,auto"
									  RowDefinitions="auto,auto"
									  ColumnSpacing="12"
									  RowSpacing="6">
									<Label Grid.Row="0"
										   Grid.Column="0"
										   Text="{l:Localize NfcSafeScan}"
										   Style="{DynamicResource FieldTitleLabel}"/>
									<Switch Grid.Row="0"
											Grid.Column="1"
											IsToggled="{Binding SafeScanEnabled, Mode=TwoWay}"/>
									<Label Grid.Row="1"
										   Grid.ColumnSpan="2"
										   Text="{l:Localize NfcSafeScanDescription}"
										   Style="{DynamicResource FieldKeyLabel}"/>
								</Grid>
							</Border>

							<Border Style="{DynamicResource BorderSet}"
									Margin="0">
								<VerticalStackLayout Spacing="12">
									<Label Text="{Binding LastTagStatusText}"
										   Style="{DynamicResource FieldTitleLabel}"/>
									<Label Text="{Binding ScanStateText}"
										   Style="{DynamicResource FieldKeyLabel}"
										   IsVisible="{Binding HasScanStateText}"/>

									<VerticalStackLayout Spacing="10">
										<VerticalStackLayout Spacing="2">
											<Label Text="{l:Localize NfcFieldId}"
												   Style="{DynamicResource FieldKeyLabel}"/>
											<Label Text="{Binding LastTagIdHex}"
												   Style="{DynamicResource FieldValueLabel}"/>
										</VerticalStackLayout>

										<VerticalStackLayout Spacing="2">
											<Label Text="{l:Localize NfcFieldType}"
												   Style="{DynamicResource FieldKeyLabel}"/>
											<Label Text="{Binding LastTagType}"
												   Style="{DynamicResource FieldValueLabel}"/>
										</VerticalStackLayout>

										<VerticalStackLayout Spacing="2">
											<Label Text="{l:Localize NfcFieldDetectedUtc}"
												   Style="{DynamicResource FieldKeyLabel}"/>
											<Label Text="{Binding LastDetectedAtUtc, StringFormat='{0:O}', TargetNullValue='â€”'}"
												   Style="{DynamicResource FieldValueLabel}"/>
										</VerticalStackLayout>

										<VerticalStackLayout Spacing="2">
											<Label Text="{l:Localize NfcFieldTechnologies}"
												   Style="{DynamicResource FieldKeyLabel}"/>
											<Label Text="{Binding LastInterfacesSummary}"
												   Style="{DynamicResource FieldValueLabel}"/>
										</VerticalStackLayout>

										<VerticalStackLayout Spacing="2"
															 IsVisible="{Binding HasNdefSummary}">
											<Label Text="{l:Localize NfcFieldNdef}"
												   Style="{DynamicResource FieldKeyLabel}"/>
											<Label Text="{Binding LastNdefSummary}"
												   Style="{DynamicResource FieldValueLabel}"/>
										</VerticalStackLayout>

										<VerticalStackLayout Spacing="2"
															 IsVisible="{Binding HasExtractedUri}">
											<Label Text="{l:Localize Uri}"
												   Style="{DynamicResource FieldKeyLabel}"/>
											<Label Text="{Binding LastExtractedUri}"
												   Style="{DynamicResource FieldValueLabel}"
												   LineBreakMode="CharacterWrap"/>
										</VerticalStackLayout>

										<Border Style="{DynamicResource BorderSet}"
												Margin="0"
												IsVisible="{Binding HasSafeScanLinkPreview}">
											<VerticalStackLayout Spacing="8">
												<Label Text="{l:Localize NfcLinkPreview}"
													   Style="{DynamicResource FieldTitleLabel}"
													   IsVisible="{Binding HasExtractedUri}"/>
												<VerticalStackLayout Spacing="2"
																	 IsVisible="{Binding HasExtractedUri}">
													<Label Text="{Binding LastExtractedUriScheme, StringFormat='Scheme: {0}'}"
														   Style="{DynamicResource FieldKeyLabel}"/>
													<Label Text="{Binding LastExtractedUriHost, StringFormat='Host: {0}'}"
														   Style="{DynamicResource FieldKeyLabel}"/>
													<Label Text="{l:Localize NfcTrustedDomain}"
														   Style="{DynamicResource FieldKeyLabel}"
														   IsVisible="{Binding IsLastExtractedUriDomainTrusted}"/>
												</VerticalStackLayout>

												<VerticalStackLayout Spacing="6"
																	 IsVisible="{Binding HasLastExtractedUriWarnings}">
													<Label Text="{l:Localize Warnings}"
														   Style="{DynamicResource FieldKeyLabel}"/>
													<CollectionView ItemsSource="{Binding LastExtractedUriWarnings}"
																	SelectionMode="None">
														<CollectionView.ItemTemplate>
															<DataTemplate>
																<Label Text="{Binding ., StringFormat='- {0}'}"
																	   Style="{DynamicResource FieldKeyLabel}"
																	   LineBreakMode="CharacterWrap"/>
															</DataTemplate>
														</CollectionView.ItemTemplate>
													</CollectionView>
												</VerticalStackLayout>

												<controls:TextButton Command="{Binding TrustLastExtractedUriDomainCommand}"
																	 Style="{DynamicResource OutlinedTextButton}"
																	 LabelData="{l:Localize NfcTrustDomain}"
																	 IsVisible="{Binding CanTrustLastExtractedUriDomain}"/>
											</VerticalStackLayout>
										</Border>

										<VerticalStackLayout Spacing="8"
															 IsVisible="{Binding HasNdefRecords}">
											<Label Text="{l:Localize NfcFieldNdefRecords}"
												   Style="{DynamicResource FieldKeyLabel}"/>
											<CollectionView ItemsSource="{Binding LastNdefRecords}"
															SelectionMode="Single"
															SelectedItem="{Binding SelectedLastNdefRecord, Mode=TwoWay}">
												<CollectionView.ItemTemplate>
													<DataTemplate x:DataType="nfc:NfcNdefRecordSnapshot">
														<VerticalStackLayout Spacing="2"
																			 Padding="0,6">
															<Label Text="{Binding RecordType}"
																   Style="{DynamicResource FieldTitleLabel}"/>
															<Label Text="{Binding DisplayValue}"
																   Style="{DynamicResource FieldValueLabel}"
																   LineBreakMode="CharacterWrap"/>
														</VerticalStackLayout>
													</DataTemplate>
												</CollectionView.ItemTemplate>
											</CollectionView>

											<Border Style="{DynamicResource BorderSet}"
													Margin="0"
													IsVisible="{Binding HasSelectedLastNdefRecord}">
												<VerticalStackLayout Spacing="10">
													<Label Text="{l:Localize NfcRecordDetails}"
														   Style="{DynamicResource FieldTitleLabel}"/>
													<Label Text="{Binding SelectedLastNdefRecord.RecordType, StringFormat='Type: {0}'}"
														   Style="{DynamicResource FieldKeyLabel}"/>
													<Label Text="{Binding SelectedLastNdefRecord.RecordTnf, StringFormat='TNF: {0}'}"
														   Style="{DynamicResource FieldKeyLabel}"/>
													<Label Text="{Binding SelectedLastNdefRecord.PayloadSizeBytes, StringFormat='Payload bytes: {0}'}"
														   Style="{DynamicResource FieldKeyLabel}"/>
													<Label Text="{Binding SelectedLastNdefRecord.DisplayValue}"
														   Style="{DynamicResource FieldValueLabel}"
														   LineBreakMode="CharacterWrap"/>

													<Label Text="{Binding SelectedLastNdefRecord.PayloadBase64, StringFormat='Base64: {0}'}"
														   Style="{DynamicResource FieldKeyLabel}"
														   LineBreakMode="CharacterWrap"
														   MaxLines="3"/>
													<Label Text="{Binding SelectedLastNdefRecord.PayloadHex, StringFormat='Hex: {0}'}"
														   Style="{DynamicResource FieldKeyLabel}"
														   LineBreakMode="CharacterWrap"
														   MaxLines="3"/>

													<Grid ColumnDefinitions="*,*"
														  ColumnSpacing="12">
														<controls:TextButton Grid.Column="0"
																			 Command="{Binding CopySelectedLastNdefRecordCommand}"
																			 Style="{DynamicResource OutlinedTextButton}"
																			 LabelData="{l:Localize CopyToClipboard}"/>
														<controls:TextButton Grid.Column="1"
																			 Command="{Binding ShareSelectedLastNdefRecordJsonCommand}"
																			 Style="{DynamicResource OutlinedTextButton}"
																			 LabelData="{l:Localize Export}"/>
													</Grid>
												</VerticalStackLayout>
											</Border>
										</VerticalStackLayout>
									</VerticalStackLayout>
								</VerticalStackLayout>
							</Border>

							<Grid ColumnDefinitions="*,*"
								  ColumnSpacing="12"
								  IsVisible="{Binding HasExtractedUri}">
								<controls:TextButton Grid.Column="0"
													 Command="{Binding CopyLastUriCommand}"
													 Style="{DynamicResource OutlinedTextButton}"
													 LabelData="{l:Localize CopyToClipboard}"/>
								<controls:TextButton Grid.Column="1"
													 Command="{Binding OpenLastUriCommand}"
													 Style="{DynamicResource FilledTextButton}"
													 LabelData="{l:Localize Open}"/>
							</Grid>

							<Grid ColumnDefinitions="*,*,*"
								  ColumnSpacing="12"
								  IsVisible="{OnPlatform iOS=True, Default=False}">
								<controls:TextButton Grid.Column="0"
													 Command="{Binding StartReadScanCommand}"
													 Style="{DynamicResource FilledTextButton}"
													 LabelData="{l:Localize NfcStartScan}"/>
								<controls:TextButton Grid.Column="1"
													 Command="{Binding RefreshCommand}"
													 Style="{DynamicResource OutlinedTextButton}"
													 LabelData="{l:Localize Refresh}"/>
								<controls:TextButton Grid.Column="2"
													 Command="{Binding ClearCommand}"
													 Style="{DynamicResource OutlinedTextButton}"
													 LabelData="{l:Localize Clear}"/>
							</Grid>

							<controls:TextButton Grid.Column="1"
													Command="{Binding ClearCommand}"
													Style="{DynamicResource OutlinedTextButton}"
													LabelData="{l:Localize Clear}"/>
						</VerticalStackLayout>
					</ScrollView>
				</controls:ViewSwitcherStateView>

				<controls:ViewSwitcherStateView StateKey="Write">
					<ScrollView>
						<VerticalStackLayout Spacing="12">
							<Label Text="{l:Localize NfcWriteUri}"
								   Style="{DynamicResource InfoLabel}"/>

							<Border Style="{DynamicResource BorderSet}">
								<VerticalStackLayout Spacing="10">
									<VerticalStackLayout Spacing="2">
										<Label Text="{l:Localize Uri}"
											   Style="{DynamicResource FieldKeyLabel}"/>
										<Entry Text="{Binding UriToWrite, Mode=TwoWay}"
											   Placeholder="{l:Localize Uri}"
											   Keyboard="Url"/>
									</VerticalStackLayout>
								</VerticalStackLayout>
							</Border>

							<Grid ColumnDefinitions="*,*"
								  ColumnSpacing="12">
								<controls:TextButton Grid.Column="0"
													 Command="{Binding StartWriteCommand}"
													 Style="{DynamicResource FilledTextButton}"
													 LabelData="{l:Localize NfcWriteStart}"/>
								<controls:TextButton Grid.Column="1"
													 Command="{Binding CancelWriteCommand}"
													 Style="{DynamicResource OutlinedTextButton}"
													 LabelData="{l:Localize Cancel}"/>
							</Grid>

							<Label Text="{Binding WriteStatusText}"
								   Style="{DynamicResource FieldValueLabel}"/>
						</VerticalStackLayout>
					</ScrollView>
				</controls:ViewSwitcherStateView>

				<controls:ViewSwitcherStateView StateKey="History">
					<CollectionView ItemsSource="{Binding HistoryItems}"
									SelectedItem="{Binding SelectedHistoryItem, Mode=TwoWay}"
									SelectionMode="Single">
						<CollectionView.Header>
							<VerticalStackLayout Spacing="12">
								<Label Text="{l:Localize NfcHistoryInfo}"
									   Style="{DynamicResource InfoLabel}"/>

								<Grid ColumnDefinitions="*,*,*"
									  ColumnSpacing="12">
									<controls:TextButton Grid.Column="0"
												 Command="{Binding ClearHistoryCommand}"
												 Style="{DynamicResource OutlinedTextButton}"
												 LabelData="{l:Localize Clear}"/>
									<controls:TextButton Grid.Column="1"
												 Command="{Binding ExportHistoryJsonCommand}"
												 Style="{DynamicResource OutlinedTextButton}"
												 LabelData="{l:Localize NfcExportAllJson}"
												 IsVisible="{Binding HasHistoryItems}"/>
									<controls:TextButton Grid.Column="2"
												 Command="{Binding ExportHistoryCsvCommand}"
												 Style="{DynamicResource OutlinedTextButton}"
												 LabelData="{l:Localize NfcExportAllCsv}"
												 IsVisible="{Binding HasHistoryItems}"/>
								</Grid>
							</VerticalStackLayout>
						</CollectionView.Header>
						<CollectionView.EmptyView>
							<Label Text="{l:Localize NfcNoHistoryYet}"
								   Style="{DynamicResource FieldValueLabel}"/>
						</CollectionView.EmptyView>
						<CollectionView.ItemTemplate>
							<DataTemplate x:DataType="viewmodel:NfcScanHistoryListItem">
								<Border Style="{DynamicResource BorderSet}"
										Margin="0,0,0,12">
									<VerticalStackLayout Spacing="6">
										<Label Text="{Binding TagType}"
											   Style="{DynamicResource FieldTitleLabel}"/>
										<Label Text="{Binding TagIdHex}"
											   Style="{DynamicResource FieldValueLabel}"/>
										<Label Text="{Binding DetectedAtUtc, StringFormat='{0:O}'}"
											   Style="{DynamicResource FieldKeyLabel}"/>
										<Label Text="{Binding ExtractedUri}"
											   Style="{DynamicResource FieldValueLabel}"
											   LineBreakMode="CharacterWrap"/>
									</VerticalStackLayout>
								</Border>
							</DataTemplate>
						</CollectionView.ItemTemplate>
					</CollectionView>
				</controls:ViewSwitcherStateView>
			</controls:ViewSwitcher.StateViews>
		</controls:ViewSwitcher>
	</Grid>
</base:BaseContentPage>
