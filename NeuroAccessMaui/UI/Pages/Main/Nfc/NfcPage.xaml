<?xml version="1.0" encoding="utf-8" ?>
<base:BaseContentPage x:Class="NeuroAccessMaui.UI.Pages.Main.Nfc.NfcPage"
					  x:Name="NfcPageRoot"
					  x:DataType="viewmodel:NfcViewModel"
					  xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
					  xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
					  xmlns:l="clr-namespace:NeuroAccessMaui.Services.Localization"
					  xmlns:base="clr-namespace:NeuroAccessMaui.UI.Pages"
					  xmlns:controls="clr-namespace:NeuroAccessMaui.UI.Controls"
					  xmlns:nfc="clr-namespace:NeuroAccessMaui.Services.Nfc.Ui"
					  xmlns:sys="clr-namespace:System;assembly=System.Runtime"
					  xmlns:viewmodel="clr-namespace:NeuroAccessMaui.UI.Pages.Main.Nfc">
	<base:BaseContentPage.Resources>
		<ResourceDictionary>
			<Style x:Key="NfcHintBubble"
				   TargetType="controls:InfoBubble">
				<Setter Property="BackgroundColor"
						Value="{DynamicResource TnPInfobgWL}"/>
				<Setter Property="ContentColor"
						Value="{DynamicResource TnPInfoContentWL}"/>
				<Setter Property="SvgSource"
						Value="info.svg"/>
				<Style.Triggers>
					<DataTrigger TargetType="controls:InfoBubble"
								 Binding="{Binding Severity}"
								 Value="{x:Static nfc:NfcScanHintSeverity.Warning}">
						<Setter Property="BackgroundColor"
								Value="{DynamicResource TnPDangerbgWL}"/>
						<Setter Property="ContentColor"
								Value="{DynamicResource TnPDangerContentWL}"/>
					</DataTrigger>
				</Style.Triggers>
			</Style>

			<!-- Field Styles (copied from existing key/value UI patterns) -->
			<Style x:Key="FieldKeyLabel"
				   TargetType="Label">
				<Setter Property="FontSize"
						Value="14"/>
				<Setter Property="FontFamily"
						Value="SpaceGroteskRegular"/>
				<Setter Property="TextColor"
						Value="{DynamicResource ContentSecondaryWL}"/>
			</Style>
			<Style x:Key="FieldValueLabel"
				   TargetType="Label">
				<Setter Property="FontSize"
						Value="16"/>
				<Setter Property="FontFamily"
						Value="SpaceGroteskRegular"/>
				<Setter Property="TextColor"
						Value="{DynamicResource ContentSecondaryWL}"/>
			</Style>
			<Style x:Key="FieldTitleLabel"
				   TargetType="Label">
				<Setter Property="FontSize"
						Value="14"/>
				<Setter Property="FontFamily"
						Value="SpaceGroteskBold"/>
				<Setter Property="TextColor"
						Value="{DynamicResource ContentSecondaryWL}"/>
			</Style>
		</ResourceDictionary>
	</base:BaseContentPage.Resources>

	<Grid RowDefinitions="auto,auto,*"
		  BackgroundColor="{DynamicResource SurfaceBackgroundWL}"
		  Padding="{DynamicResource LargeMargins}">
		<Grid ColumnDefinitions="auto,*,auto"
			  ColumnSpacing="16">
			<controls:SvgButton Grid.Row="0"
								Grid.Column="0"
								Command="{Binding GoBackCommand}"
								SvgSource="close.svg"
								Style="{DynamicResource IconButton}"
								HorizontalOptions="Start"
								WidthRequest="44"
								HeightRequest="44"/>
			<Label Grid.Column="1"
				   Text="{l:Localize NFC}"
				   Style="{DynamicResource PageTitleLabel}"
				   VerticalOptions="Center">
				<Label.GestureRecognizers>
					<TapGestureRecognizer Command="{Binding TitleTappedCommand}"/>
				</Label.GestureRecognizers>
			</Label>
			<controls:SvgButton Grid.Row="0"
								Grid.Column="2"
								Command="{Binding OpenSafetySettingsCommand}"
								SvgSource="{AppThemeBinding Light=dots_vertical_light.svg, Dark=dots_vertical_dark.svg}"
								Style="{DynamicResource IconButton}"
								HorizontalOptions="End"
								WidthRequest="44"
								HeightRequest="44"/>
		</Grid>

		<Grid Grid.Row="1"
			  ColumnDefinitions="*,*,*"
			  ColumnSpacing="12"
			  Margin="0,16,0,0">
			<controls:TextButton Grid.Column="0"
								 Command="{Binding SelectReadTabCommand}"
								 Style="{Binding ReadTabButtonStyle}"
								 LabelData="{l:Localize NfcRead}"/>
			<controls:TextButton Grid.Column="1"
								 Command="{Binding SelectWriteTabCommand}"
								 Style="{Binding WriteTabButtonStyle}"
								 LabelData="{l:Localize NfcWrite}"/>
			<controls:TextButton Grid.Column="2"
								 Command="{Binding SelectHistoryTabCommand}"
								 Style="{Binding HistoryTabButtonStyle}"
								 LabelData="{l:Localize NfcHistory}"/>
		</Grid>

		<controls:ViewSwitcher Grid.Row="2"
							   Margin="0,16,0,0"
							   SelectedStateKey="{Binding SelectedTabKey, Mode=TwoWay}">
			<controls:ViewSwitcher.StateViews>
				<controls:ViewSwitcherStateView StateKey="Read">
					<ScrollView>
						<VerticalStackLayout Spacing="12">
							<Label Text="{l:Localize NfcTapTag}"
								   Style="{DynamicResource InfoLabel}"/>

							<Border Style="{DynamicResource BorderSet}"
									Margin="0">
								<VerticalStackLayout Spacing="12">
									<Label Text="{Binding LastTagStatusText}"
										   Style="{DynamicResource FieldTitleLabel}"/>
									<Label Text="{Binding ScanStateText}"
										   Style="{DynamicResource FieldKeyLabel}"
										   IsVisible="{Binding HasScanStateText}"/>
									<VerticalStackLayout Spacing="8"
												IsVisible="{Binding HasScanHints}"
												BindableLayout.ItemsSource="{Binding ScanHints}">
										<BindableLayout.ItemTemplate>
											<DataTemplate x:DataType="nfc:NfcScanHint">
												<controls:InfoBubble Style="{StaticResource NfcHintBubble}"
																 LabelText="{Binding Text}"/>
											</DataTemplate>
										</BindableLayout.ItemTemplate>
									</VerticalStackLayout>
									<VerticalStackLayout Spacing="10">
										<VerticalStackLayout Spacing="2">
											<Label Text="{l:Localize NfcFieldId}"
												   Style="{DynamicResource FieldTitleLabel}"/>
											<Label Text="{Binding LastTagIdHex}"
												   Style="{DynamicResource FieldValueLabel}"/>
										</VerticalStackLayout>

										<VerticalStackLayout Spacing="2">
											<Label Text="{l:Localize NfcFieldType}"
												   Style="{DynamicResource FieldTitleLabel}"/>
											<Label Text="{Binding LastTagType}"
												   Style="{DynamicResource FieldValueLabel}"/>
										</VerticalStackLayout>

										<VerticalStackLayout Spacing="2">
											<Label Text="{l:Localize NfcFieldDetectedUtc}"
												   Style="{DynamicResource FieldTitleLabel}"/>
											<Label Text="{Binding LastDetectedAtUtc, StringFormat='{0:O}', TargetNullValue='â€”'}"
												   Style="{DynamicResource FieldValueLabel}"/>
										</VerticalStackLayout>

										<VerticalStackLayout Spacing="2">
											<Label Text="{l:Localize NfcFieldTechnologies}"
												   Style="{DynamicResource FieldTitleLabel}"/>
											<Label Text="{Binding LastInterfacesSummary}"
												   Style="{DynamicResource FieldValueLabel}"/>
										</VerticalStackLayout>

										<VerticalStackLayout Spacing="2"
															 IsVisible="{Binding HasNdefSummary}">
											<Label Text="{l:Localize NfcFieldNdef}"
												   Style="{DynamicResource FieldTitleLabel}"/>
											<Label Text="{Binding LastNdefSummary}"
												   Style="{DynamicResource FieldValueLabel}"/>
										</VerticalStackLayout>

										<VerticalStackLayout Spacing="2"
															 IsVisible="{Binding HasExtractedUri}">
											<Label Text="{l:Localize Uri}"
												   Style="{DynamicResource FieldTitleLabel}"/>
											<Label Text="{Binding LastExtractedUri}"
												   Style="{DynamicResource FieldValueLabel}"
												   LineBreakMode="CharacterWrap"/>
										</VerticalStackLayout>

										<Border Style="{DynamicResource BorderSet}"
												Margin="0"
												IsVisible="{Binding HasSafeScanLinkPreview}">
											<VerticalStackLayout Spacing="8">
												<Label Text="{l:Localize NfcLinkPreview}"
													   Style="{DynamicResource FieldTitleLabel}"
													   IsVisible="{Binding HasExtractedUri}"/>
												<VerticalStackLayout Spacing="2"
																	 IsVisible="{Binding HasExtractedUri}">
													<Label Text="{Binding LastExtractedUriScheme, StringFormat='Scheme: {0}'}"
														   Style="{DynamicResource FieldKeyLabel}"/>
													<Label Text="{Binding LastExtractedUriHost, StringFormat='Host: {0}'}"
														   Style="{DynamicResource FieldKeyLabel}"/>
													<Label Text="{l:Localize NfcTrustedDomain}"
														   Style="{DynamicResource FieldKeyLabel}"
														   IsVisible="{Binding IsLastExtractedUriDomainTrusted}"/>
												</VerticalStackLayout>

												<VerticalStackLayout Spacing="6"
																	 IsVisible="{Binding HasLastExtractedUriWarnings}">
													<Label Text="{l:Localize Warnings}"
														   Style="{DynamicResource FieldKeyLabel}"/>
													<CollectionView ItemsSource="{Binding LastExtractedUriWarnings}"
																	SelectionMode="None">
														<CollectionView.ItemTemplate>
															<DataTemplate>
																<Label Text="{Binding ., StringFormat='- {0}'}"
																	   Style="{DynamicResource FieldKeyLabel}"
																	   LineBreakMode="CharacterWrap"/>
															</DataTemplate>
														</CollectionView.ItemTemplate>
													</CollectionView>
												</VerticalStackLayout>

												<controls:TextButton Command="{Binding TrustLastExtractedUriDomainCommand}"
																	 Style="{DynamicResource OutlinedTextButton}"
																	 LabelData="{l:Localize NfcTrustDomain}"
																	 IsVisible="{Binding CanTrustLastExtractedUriDomain}"/>
											</VerticalStackLayout>
										</Border>

										<VerticalStackLayout Spacing="8"
															 IsVisible="{Binding HasNdefRecords}">
											<Label Text="{l:Localize NfcFieldNdefRecords}"
												   Style="{DynamicResource FieldTitleLabel}"/>
											<CollectionView ItemsSource="{Binding LastNdefRecords}"
													SelectionMode="None" ItemSizingStrategy="MeasureAllItems">
												<CollectionView.ItemTemplate>
													<DataTemplate x:DataType="nfc:NfcNdefRecordSnapshot">
															<controls:TemplatedButton
																Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:NfcViewModel}}, Path=OpenNdefRecordDetailsCommand, x:DataType=viewmodel:NfcViewModel}"
																CommandParameter="{Binding .}">
																<Border Style="{DynamicResource BorderSubSet}"
																		Margin="0,6,0,0">
																	<VerticalStackLayout Spacing="2">
																		<Label Text="{Binding RecordType}"
																			Style="{DynamicResource FieldTitleLabel}"/>
																		<Label Text="{Binding DisplayValue}"
																			Style="{DynamicResource FieldValueLabel}"
																			LineBreakMode="CharacterWrap"/>
																</VerticalStackLayout>
															</Border>
														</controls:TemplatedButton>
													</DataTemplate>
												</CollectionView.ItemTemplate>
											</CollectionView>
										</VerticalStackLayout>
									</VerticalStackLayout>
								</VerticalStackLayout>
							</Border>

							<Grid ColumnDefinitions="*,*"
								  ColumnSpacing="12"
								  IsVisible="{Binding HasExtractedUri}">
								<controls:TextButton Grid.Column="0"
													 Command="{Binding CopyLastUriCommand}"
													 Style="{DynamicResource OutlinedTextButton}"
													 LabelData="{l:Localize CopyToClipboard}"/>
								<controls:TextButton Grid.Column="1"
													 Command="{Binding OpenLastUriCommand}"
													 Style="{DynamicResource FilledTextButton}"
													 LabelData="{l:Localize Open}"/>
							</Grid>

								<controls:TextButton Grid.Column="0"
													 Command="{Binding StartReadScanCommand}"
													 Style="{DynamicResource FilledTextButton}"
													 LabelData="{l:Localize NfcStartScan}"/>

								<Border Style="{DynamicResource BorderSet}"
										Margin="0"
										IsVisible="{Binding IsDebugToolsEnabled}">
									<VerticalStackLayout Spacing="10">
										<Label Text="{l:Localize NfcDebugToolsTitle}"
											   Style="{DynamicResource FieldTitleLabel}"/>
										<Label Text="{l:Localize NfcDebugToolsDescription}"
											   Style="{DynamicResource FieldKeyLabel}"/>
										<Grid ColumnDefinitions="*,*"
											  RowDefinitions="auto, auto"
											  ColumnSpacing="12"
											  RowSpacing="12">
											<controls:TextButton Grid.Column="0"
															 Grid.Row="0"
														 Command="{Binding FakeScanUriCommand}"
														 Style="{DynamicResource OutlinedTextButton}"
														 LabelData="{l:Localize NfcDebugFakeScanUri}"/>
											<controls:TextButton Grid.Column="1"
															 Grid.Row="0"
														 Command="{Binding FakeScanNoNdefCommand}"
														 Style="{DynamicResource OutlinedTextButton}"
														 LabelData="{l:Localize NfcDebugFakeScanNoNdef}"/>
											<controls:TextButton Grid.Column="0"
															 Grid.Row="1"
														 Command="{Binding FakeScanUnknownSchemeCommand}"
														 Style="{DynamicResource OutlinedTextButton}"
														 LabelData="{l:Localize NfcDebugFakeScanUnknownScheme}"/>
											<controls:TextButton Grid.Column="1"
															 Grid.Row="1"
														 Command="{Binding FakeScanKnownAppSchemeCommand}"
														 Style="{DynamicResource OutlinedTextButton}"
														 LabelData="{l:Localize NfcDebugFakeScanKnownAppScheme}"/>
										</Grid>
									</VerticalStackLayout>
								</Border>

							<controls:TextButton Grid.Column="1"
												 Command="{Binding ClearCommand}"
												 Style="{DynamicResource OutlinedTextButton}"
												 LabelData="{l:Localize Clear}"/>
						</VerticalStackLayout>
					</ScrollView>
				</controls:ViewSwitcherStateView>

				<controls:ViewSwitcherStateView StateKey="Write">
					<ScrollView>
						<VerticalStackLayout Spacing="12">
							<Label Text="{l:Localize NfcWriteInfo}"
								   Style="{DynamicResource InfoLabel}"/>

							<Border Style="{DynamicResource BorderSet}"
									Margin="0">
								<VerticalStackLayout Spacing="10">
									<Label Text="{l:Localize NfcWriteInsertFromTitle}"
										   Style="{DynamicResource FieldTitleLabel}"/>
									<Label Text="{l:Localize NfcWriteInsertFromDescription}"
										   Style="{DynamicResource FieldKeyLabel}"/>
									<Grid ColumnDefinitions="*,*,*"
										  ColumnSpacing="12">
										<controls:TextButton Grid.Column="0"
													 Command="{Binding InsertEdalerUriCommand}"
													 Style="{DynamicResource OutlinedTextButton}"
													 LabelData="{l:Localize NfcWriteInsertEdalerUri}"/>
										<controls:TextButton Grid.Column="1"
													 Command="{Binding InsertContractPayloadCommand}"
													 Style="{DynamicResource OutlinedTextButton}"
													 LabelData="{l:Localize NfcWriteInsertContract}"/>
										<controls:TextButton Grid.Column="2"
													 Command="{Binding InsertTokenPayloadCommand}"
													 Style="{DynamicResource OutlinedTextButton}"
													 LabelData="{l:Localize NfcWriteInsertToken}"/>
									</Grid>
								</VerticalStackLayout>
							</Border>

							<Border Style="{DynamicResource BorderSet}" Margin="0">
								<VerticalStackLayout Spacing="10">
									<controls:CompositePicker ItemsSource="{Binding WritePayloadTypeOptions}"
														SelectedItem="{Binding SelectedWritePayload, Mode=TwoWay}"
														LabelText="{l:Localize NfcWritePayloadTypeLabel}"
														Placeholder="{l:Localize NfcWritePayloadTypeLabel}"
														Style="{DynamicResource RegularCompositePicker}">
										<controls:CompositePicker.ItemDisplayBinding x:DataType="viewmodel:NfcViewModel+NfcWritePayloadTypeOption">
											<Binding Path="Label" />
										</controls:CompositePicker.ItemDisplayBinding>
									</controls:CompositePicker>

									<controls:CompositeEntry Style="{DynamicResource RegularCompositeEntry}"
														LabelText="{l:Localize Uri}"
														Placeholder="{l:Localize Uri}"
														Keyboard="Url"
														EntryData="{Binding UriToWrite, Mode=TwoWay}"
														IsVisible="{Binding IsWritePayloadUri}"/>

									<VerticalStackLayout Spacing="2"
													 IsVisible="{Binding IsWritePayloadText}">
										<Label Text="{l:Localize NfcWriteTextLabel}"
											   Style="{DynamicResource FieldKeyLabel}"/>
										<Editor Text="{Binding TextToWrite, Mode=TwoWay}"
												AutoSize="TextChanges"
												Placeholder="{l:Localize NfcWriteTextPlaceholder}"/>
									</VerticalStackLayout>

									<Label Text="{Binding WriteSizeText}"
										   Style="{DynamicResource FieldKeyLabel}"
										   IsVisible="{Binding HasWriteSizeText}"/>

									<Grid ColumnDefinitions="*,auto"
											  RowDefinitions="auto,auto"
											  ColumnSpacing="12"
											  RowSpacing="6">
										<Label Grid.Row="0"
											   Grid.Column="0"
											   Text="{l:Localize NfcWriteVerifyAfterWrite}"
											   Style="{DynamicResource FieldTitleLabel}"/>
										<Switch Grid.Row="0"
												Grid.Column="1"
												IsToggled="{Binding VerifyAfterWrite, Mode=TwoWay}"/>
										<Label Grid.Row="1"
											   Grid.ColumnSpan="2"
											   Text="{l:Localize NfcWriteVerifyAfterWriteDescription}"
											   Style="{DynamicResource FieldKeyLabel}"/>
									</Grid>
								</VerticalStackLayout>
							</Border>

							<Grid ColumnDefinitions="*,*"
								  ColumnSpacing="12">
								<controls:TextButton Grid.Column="0"
													 Command="{Binding StartWriteCommand}"
													 Style="{DynamicResource FilledTextButton}"
													 LabelData="{l:Localize NfcWriteStart}"/>
								<controls:TextButton Grid.Column="1"
													 Command="{Binding CancelWriteCommand}"
													 Style="{DynamicResource OutlinedTextButton}"
													 LabelData="{l:Localize Cancel}"/>
							</Grid>

							<Label Text="{Binding WriteStatusText}"
								   Style="{DynamicResource FieldValueLabel}"/>
						</VerticalStackLayout>
					</ScrollView>
				</controls:ViewSwitcherStateView>

				<controls:ViewSwitcherStateView StateKey="History">
					<CollectionView ItemsSource="{Binding HistoryItems}"
									SelectedItem="{Binding SelectedHistoryItem, Mode=TwoWay}"
									SelectionMode="Single">
						<CollectionView.Header>
							<VerticalStackLayout Spacing="12">
								<Label Text="{l:Localize NfcHistoryInfo}"
									   Style="{DynamicResource InfoLabel}"/>

								<Grid RowDefinitions="Auto,Auto"
									  ColumnDefinitions="*,*"
									  ColumnSpacing="12"
									  RowSpacing="12"
									  Margin="0,0,0,16">
									<controls:TextButton Grid.Row="0"
											Grid.Column="0"
														 Command="{Binding ClearHistoryCommand}"
														 Style="{DynamicResource OutlinedTextButton}"
														 LabelData="{l:Localize Clear}"/>
									<controls:TextButton Grid.Row="0"
											Grid.Column="1"
														 Command="{Binding ExportHistoryJsonCommand}"
														 Style="{DynamicResource OutlinedTextButton}"
														 LabelData="{l:Localize NfcExportAllJson}"
														 IsVisible="{Binding HasHistoryItems}"/>
									<controls:TextButton Grid.Row="1"
											Grid.Column="0"
														 Command="{Binding ExportHistoryCsvCommand}"
														 Style="{DynamicResource OutlinedTextButton}"
														 LabelData="{l:Localize NfcExportAllCsv}"
														 IsVisible="{Binding HasHistoryItems}"/>
									<controls:TextButton Grid.Row="1"
											Grid.Column="1"
														 Command="{Binding ExportHistoryXmlCommand}"
														 Style="{DynamicResource OutlinedTextButton}"
														 LabelData="{l:Localize NfcExportAllXml}"
														 IsVisible="{Binding HasHistoryItems}"/>
								</Grid>
							</VerticalStackLayout>
						</CollectionView.Header>
						<CollectionView.EmptyView>
							<Label Text="{l:Localize NfcNoHistoryYet}"
								   Style="{DynamicResource FieldValueLabel}"/>
						</CollectionView.EmptyView>
						<CollectionView.ItemTemplate>
							<DataTemplate x:DataType="viewmodel:NfcScanHistoryListItem">
								<Border Style="{DynamicResource BorderSet}"
										Margin="0,0,0,12">
									<VerticalStackLayout Spacing="6">
										<Label Text="{Binding TagType}"
											   Style="{DynamicResource FieldTitleLabel}"/>
										<Label Text="{Binding TagIdHex}"
											   Style="{DynamicResource FieldValueLabel}"/>
										<Label Text="{Binding DetectedAtUtc, StringFormat='{0:O}'}"
											   Style="{DynamicResource FieldKeyLabel}"/>
										<Label Text="{Binding ExtractedUri}"
											   Style="{DynamicResource FieldValueLabel}"
											   LineBreakMode="CharacterWrap"/>
									</VerticalStackLayout>
								</Border>
							</DataTemplate>
						</CollectionView.ItemTemplate>
					</CollectionView>
				</controls:ViewSwitcherStateView>
			</controls:ViewSwitcher.StateViews>
		</controls:ViewSwitcher>
	</Grid>
</base:BaseContentPage>
